var request=require("request"),cheerio=require("cheerio"),CONFIG=require("./hidden_config.js"),Definitions=require("./models.js"),orm=require("orm"),Promise=require("promise");function str_to_date(a){a=a.split("-");return new Date(a[2],a[1]-1,a[0])}
function doreq(){console.log("Reading at",(new Date).toTimeString());request(CONFIG.URL_1,function(a,b,c){if(!a&&200==b.statusCode){var d=cheerio.load(c),e=[];d(CONFIG.TABLE_ID_1).find("tr+tr").each(function(a,c){var b=[],f=d(c).find("td").eq(0).find("a").attr("href").split("=")[1];b.push(f);d(c).find("td+td").each(function(a,c){b.push(d(c).text().trim())});b[11]=str_to_date(b[11]);e.push(b)});DuplicationCheck(e)}})}
function SaveStock(a){console.log("Writing",a.length,"at",(new Date).toTimeString());if(a.constructor!==Array||0===a.length)console.log("[SaveStock]","arg is not an array or is empty"),Process();else{var b=orm.connect(CONFIG.CONNECTION_STRING);b.on("connect",function(a){if(a)throw a;a=new Definitions.Tickers(b,CONFIG.DB_TABLE_1);console.log("SaveStock",a);b.close();Process()})}}function str_to_date(a){a=a.split("-");return new Date(a[2],a[1]-1,a[0])}
function DuplicationCheck(a){console.log("Checking for duplication (",a.length," records)");Check(a)}function getConnection(){return new Promise(function(a,b){orm.connect(CONFIG.CONNECTION_STRING,function(c,d){c?b(c):a(d)})})}function constructObject(a){return{ticker_id:a[0],last:a[1],change:a[2],open:a[3],high:a[4],low:a[5],vol:a[6],trade:a[7],value:a[8],prev:a[9],ref:a[10],prev_date:str_to_date(a[11]),bid:a[12],ask:a[13]}}
function Check(a){getConnection().then(function(b){Promise.all(a.map(function(a){var d,e;return new Promise(function(g,h){d=g;e=h;var k=new Definitions.Tickers(b,CONFIG.DB_TABLE_1),f=constructObject(a);k.find(f,function(a,b){if(a)e(a);else{var c=null;0===b.length&&(c=f);d(c)}})})})).done(function(a){b.close();a=a.filter(function(a){return null!==a});0<a.length?SaveStock(a):Process()})})}function Process(){setTimeout(function(){doreq()},2E4)}doreq();